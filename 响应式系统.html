<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        // 暂时存储本次注册的副作用函数
        let activeEffect = null;
        // 存储所有注册的对应对象的对应的key的对应的副作用函数的桶
        let bucket = new WeakMap();

        // effect函数， 用于注册副作用函数
        function effect(fn) {
            const effectFn = () => {
                    clearUp(effectFn);
                    activeEffect = effectFn;
                    fn()
                }
                // 存储保存的有该副作用函数的依赖集合
            effectFn.deps = [];
            effectFn()
        }

        // clearUp 将副作用函数从其依赖集合中删除
        function clearUp(effectFn) {
            for (let i = 0; i < effectFn.deps.length; i++) {
                effectFn.deps[i].delete(effectFn)
            }
            effectFn.deps.length = 0;
        }

        //创建响应式代理
        function createProxy(data) {
            return new Proxy(data, {
                get(target, key) {
                    track(target, key);
                    return target[key];
                },
                set(target, key, newVal) {
                    target[key] = newVal;
                    trigger(target, key);
                }
            })
        }

        // 追踪函数，将对应对象的对应的key的对应的副作用函数存储进bucket
        function track(target, key) {
            if (!activeEffect) return;
            let depsMap = bucket.get(target);
            if (!depsMap) bucket.set(target, (depsMap = new Map()));
            let deps = depsMap.get(key);
            if (!deps) depsMap.set(key, (deps = new Set()));
            deps.add(activeEffect);
            activeEffect.deps.push(deps);
        }
        // 调用bucket里面存储的相应的副作用函数
        function trigger(target, key) {
            let depsMap = bucket.get(target);
            if (!depsMap) return;
            let effects = depsMap.get(key);
            let effectsToRun = new Set(effects);
            effectsToRun.forEach((effect) => {
                effect()
            })
        }


        // 测试
        const obj = createProxy({
            name: 'wuLuo'
        });
        effect(() => {
            document.body.innerHTML = obj.name
        })
        setTimeout(() => {
            obj.name = 'ziMu'
        }, 5000)
    </script>
</body>

</html>